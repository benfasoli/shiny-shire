---
title: "SMAUG Cluster Utilization"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: scroll
    theme: simplex
    css: styles.css
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)

db <- reactiveFileReader(10000, session, 'db.rds', function(x) {
  readRDS(x)
})

# Persistent database for utilization and dates
observe({
  users <- c('ben', 'daniel', 'derek', 'dien', 'henrique', 'john')
  for (i in 1:length(users)) {
    if (db()$dates[i] >= Sys.Date())
      updateSliderInput(session, paste0('s', users[i]), value=db()$sliders[i])
      updateDateInput(session, paste0('d', users[i]), value=db()$dates[i])
  }
})

observe({
  dates = c(input$dben, input$ddaniel, input$dderek, input$ddien, input$dhenrique, input$djohn)
  sliders = c(input$sben, input$sdaniel, input$sderek, input$sdien, input$shenrique, input$sjohn)
  saveRDS(data.frame(dates = dates, sliders = sliders), 'db.rds')
})
```

Column {data-width=650}
-----------------------------------------------------------------------

### SMAUG SLURM Users

```{r}
fixedRow(
  column(2, h4('User (a-z)')),
  column(7, h4('Node utilization')),
  column(3, h4('Expected end'))
)

hr()

fluidRow(
  column(2, h4('Ben')),
  column(7, sliderInput('sben', NULL, 1, 10, 1, step = 1, ticks = F, width = '100%')),
  column(3, dateInput('dben', NULL, value = Sys.Date()))
)

fluidRow(
  column(2, h4('Daniel')),
  column(7, sliderInput('sdaniel', NULL, 1, 10, 1, step = 1, ticks = F, width = '100%')),
  column(3, dateInput('ddaniel', NULL, value = Sys.Date()))
)

fluidRow(
  column(2, h4('Derek')),
  column(7, sliderInput('sderek', NULL, 1, 10, 1, step = 1, ticks = F, width = '100%')),
  column(3, dateInput('dderek', NULL, value = Sys.Date()))
)

fluidRow(
  column(2, h4('Dien')),
  column(7, sliderInput('sdien', NULL, 1, 10, 1, step = 1, ticks = F, width = '100%')),
  column(3, dateInput('ddien', NULL, value = Sys.Date()))
)

fluidRow(
  column(2, h4('Henrique')),
  column(7, sliderInput('shenrique', NULL, 1, 10, 1, step = 1, ticks = F, width = '100%')),
  column(3, dateInput('dhenrique', NULL, value = Sys.Date()))
)

fluidRow(
  column(2, h4('John')),
  column(7, sliderInput('sjohn', NULL, 1, 10, 1, step = 1, ticks = F, width = '100%')),
  column(3, dateInput('djohn', NULL, value = Sys.Date()))
)
```

Column {data-width=350}
-----------------------------------------------------------------------

### Total node allocation

```{r}
renderValueBox({
  sliders = c(input$sben, input$sdaniel, input$sderek, input$sdien, input$shenrique, input$sjohn)
  total <- sum(sliders)
  color <- if (total <= 10) { 'success'
  } else if (total > 10 && total <= 14) { 'warning'
  } else 'danger'
  valueBox(total, color = color, icon = 'fa-refresh fa-spin')
})
```

### Nodes idle

```{r}
renderValueBox({
  sliders = c(input$sben, input$sdaniel, input$sderek, input$sdien, input$shenrique, input$sjohn)
  total <- sum(sliders)
  avail <- 15 - total
  color <- if (avail < 1) { 'danger'
  } else if (avail >= 1 && avail <= 4) { 'warning'
  } else 'success'
  icon <- if (avail < 1) { 'fa-ban'
  } else if (avail >= 1 && avail <= 4) { 'fa-thumbs-up'
  } else 'fa-thumbs-up'
  valueBox(avail, color = color, icon = icon)
})
```

### More noads available

```{r}
renderValueBox({
  dates = c(input$dben, input$ddaniel, input$dderek, input$ddien, input$dhenrique, input$djohn)
  dates = dates[dates > Sys.Date()]
  if (length(dates) < 1) {
    closestDate <- 'Now'
  } else {
    closestDate <- min(dates)
    nday <- closestDate - Sys.Date()
    closestDate <- format(closestDate, '%m-%d')
  }
  valueBox(closestDate, color = 'info', icon = 'fa-calendar')
})
```
